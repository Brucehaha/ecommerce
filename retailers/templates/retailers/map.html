{% extends "base.html" %}
{% load static %}

{% block title %}map{% endblock%}
{% block css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ==" crossorigin=""/>

{% endblock %}
{% block js %}
<script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js" integrity="sha512-tAGcCfR4Sc5ZP5ZoVz0quoZDYX5aCtEm/eu1KhSLj2c9eFrylXZknQYmxUssFaVJKvvc0dJQixhGjG2yXWiV9Q==" crossorigin=""></script>
<script>
$(document).ready(function(){
    var url='/retailers/RetailerMapAjax/';
    var method='GET';
    $.ajax({
        url:url,
        method:method,
        success: function(responseData){
            console.log(responseData.business[0]['location']);
            const business = responseData.business;
            renderMap(business)
        },
        errer: function(error){
            $.alert("An error occured")
        }
    })
});
const greeni = '{% static "retailers/img/marker-green.png" %}'
const redi = '{% static "retailers/img/marker-red.png" %}'
const yellowi = '{% static "retailers/img/marker-yellow.png" %}'
const s = '{% static "retailers/img/marker-shadow.png" %}'

const renderMap = (business) => {
    const greenIcon = L.icon({
        iconUrl: greeni,
        shadowUrl: s,
        iconSize:     [38, 95], // size of the icon
        shadowSize:   [50, 64], // size of the shadow
        iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
        shadowAnchor: [4, 62],  // the same for the shadow
        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
    });
    const redIcon = L.icon({
        iconUrl: redi,
        shadowUrl: s,
        iconSize:     [38, 95], // size of the icon
        shadowSize:   [50, 64], // size of the shadow
        iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
        shadowAnchor: [4, 62],  // the same for the shadow
        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
    });
    const yellowIcon = L.icon({
        iconUrl: yellowi,
        shadowUrl: s,
        iconSize:     [38, 95], // size of the icon
        shadowSize:   [50, 64], // size of the shadow
        iconAnchor:   [22, 94], // point of the icon which will correspond to marker's location
        shadowAnchor: [4, 62],  // the same for the shadow
        popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
    });

    const grayscaleUrl = 'http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png';
    const streetsUrl = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    const list = [];
    let markerIcon ='';
    for (i=0; i < business.length; i++) {
        const location = business[i]['location'];
        const name = business[i]['name'];
        const count = business[i]['count'];
        const samples = business[i]['samples'];
        if (count >= 31){
            markerIcon = greenIcon;
        } else if (count<31&&count>=15){
            markerIcon = redIcon
        } else{
            markerIcon = yellowIcon
        }
        let marker = L.marker(location, {icon:markerIcon})
                      .bindPopup('<h4>'+name+'</h4>'+''+'No.: '+count+'<br />'+'Samples: '+samples.join(' | '))
        list.push(marker)

    }
    // var tfc = L.marker([-37.746243, 145.0041753]).bindPopup('This is GD flooring');
    // var gfc = L.marker(location).bindPopup('This is Goldenfield, CO.'+location);

    var Melbourne = L.layerGroup(list);

    var grayscale = L.tileLayer(grayscaleUrl, {id: 'MapID'}),
        streets   = L.tileLayer(streetsUrl, {id: 'MapID'});



    var mymap = L.map('mapid', {
        center: [-37.8136, 144.9631],
        zoom: 10,
        layers: [grayscale, Melbourne],
        attributionControl: false,
    });
    $(".nav-link").click(function(e) {
        $(".active").removeClass("active");
        $(this).addClass("active");
        var pos = e.target.getAttribute('data-position');
        var zoom = e.target.getAttribute('data-zoom');
        if (pos && zoom) {
            var loc = pos.split(',');
            var z = parseInt(zoom);
            mymap.setView(loc, z, {animation: true});
            return false;
        }
    });


    var baseMaps = {
        "<span style='color: gray'>Grayscale</span>": grayscale,
        "Streets": streets
    };
    //
    var overlayMaps = {
        "Cities": Melbourne
    };

    L.control.layers(baseMaps, overlayMaps).addTo(mymap);

}



 // var mymap = L.map('mapid').setView([-37.8136, 144.9631], 10);
 // L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png').addTo(mymap);
// var tfc = L.marker([-37.746243, 145.0041753]).addTo(mymap).bindPopup('This is GD Flooring');
// var gfc = L.marker([-37.7167725, 144.9826217]).addTo(mymap).bindPopup('This is Goldenfield');


 </script>
{% endblock %}

{% block map %}
<div id="map" class="my-4 mx">
<ul class="nav nav-pills">
      <li class="nav-item">
        <a href="#" class="nav-link active" data-zoom="10" data-position="-37.8136, 144.9631">
            Melbourne
        </a>
      </li>
       <li class="nav-item">
        <a href="#" class="nav-link" data-zoom="10" data-position="-33.8688,151.2093">
            Sydney
        </a>
     </li>
</ul>


</div>
<div class="my-1 mx" id="mapid" style="height:680px;"></div>
{% endblock %}
